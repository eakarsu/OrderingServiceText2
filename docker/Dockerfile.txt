FROM python:latest

ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    postgresql \
    postgresql-contrib \
    gcc \
    libpq-dev \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY . /app

# Install Python dependencies
RUN pip install --upgrade pip
RUN pip install --no-cache-dir -r requirements.txt

# Initialize PostgreSQL, create database and table
USER postgres
RUN /etc/init.d/postgresql start && \
    psql --command "CREATE DATABASE restaurant_orders;" && \
    psql -d restaurant_orders --command "CREATE TABLE IF NOT EXISTS orders (id SERIAL PRIMARY KEY, phone_number VARCHAR(15) NOT NULL, order_data JSONB NOT NULL, orderdate TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP, status VARCHAR(20) DEFAULT 'pending');" && \
    /etc/init.d/postgresql stop

USER root

EXPOSE 8000

# Run menuIndexer.py to set up ChromaDB, then start main.py
CMD service postgresql start && \
    python menuIndexer.py && \
    python main.py

